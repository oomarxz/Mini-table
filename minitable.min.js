const _MINI_ICONS={view:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',edit:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',delete:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',drag:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>',reset:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>'};class MiniTable{constructor(t,e){this.containerSelector=t,this.container=document.querySelector(t),this.config=e,this.url=e.url,this.urlEliminar=e.urlEliminar||null,this.urlDetail=e.urlDetail||null,this.urlOrden=e.urlOrden||null,this.permissions={},this.botonesExtra=e.botonesExtra||[],this.botonesFlotantes=!1!==e.botonesFlotantes,this.permissions={view:1,create:1,edit:1,delete:1},this.columnas=e.columns,this.limite=e.paginacion||5,this.seleccionable=e.seleccionable||!1,this.editable=e.editable||!1,this.draggable=e.draggable||!1,this.urlUpdate=e.urlUpdate||null,this.paginaActual=1,this.datosCompletos=[],this.datosFiltrados=[],this.ordenColumna=null,this.ordenAscendente=!0,this.container&&this.init()}async init(){console.log("%c MiniTable v1.0 %c By OrtegaDevs %c","color: #fff; background: #0d6efd; padding: 3px 10px; border-radius: 3px 0 0 3px; font-weight: bold;","color: #0d6efd; background: #e9ecef; padding: 3px 10px; border-radius: 0 3px 3px 0; font-weight: bold;","background: transparent"),this.container.innerHTML=`\n            <div class="mini-table-header">\n                <div class="header-control-group-container">\n                    <div class="header-control-group">\n                        <span>Mostrar</span>\n                        <select class="change-limit">\n                            <option value="10">10</option>\n                            <option value="20">20</option>\n                            <option value="50">50</option>\n                            <option value="100">100</option>\n                        </select>\n                        <span>registros</span>\n                    </div>\n                    \n                    <div class="header-control-group search-group">\n                        <label>Buscar: </label>\n                        <div class="search-container">\n                            <input type="text" class="table-search" placeholder="Filtrar datos...">\n                            <button class="btn-gmail-icon icon-refresh" title="Refrescar">\n                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">\n                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>\n                                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>\n                                </svg>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class="menu-acciones-iconos">\n                <button class="btn-gmail-icon btn-cancelar-todo" title="Desmarcar todo">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>\n                </button>\n                <div class="acciones-seleccion-group" style="display: flex; gap: 8px;">\n                    <button class="btn-gmail-icon icon-delete" title="Eliminar seleccionados">\n                        ${_MINI_ICONS.delete}\n                    </button>\n                    <button class="btn-gmail-icon icon-export" title="Exportar a Excel">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>\n                    </button>\n                </div>\n            </div>\n            \n            <div class="mini-table-wrapper">\n                <table class="mini-table">\n                    <thead><tr class="head-row"></tr></thead>\n                    <tbody class="body-rows"></tbody>\n                </table>\n            </div>\n            <div class="mini-pagination"></div>`;const t="mt-"+Math.random().toString(36).substring(2,7),e=document.createElement("div");e.className=t,e.style="font-size: 10px; color: #ccc; text-align: right; padding: 5px; cursor: default; user-select: none; display: block !important;";const i="Devs",n="Ortega";e.innerText=`MiniTable By ${n}${i}`,this.container.appendChild(e),setTimeout(()=>{const t=e,i=t?t.getBoundingClientRect():{width:0,height:0},n=window.getComputedStyle(t||{});!t||!this.container.contains(t)||"MiniTable By OrtegaDevs"!==t.innerText.trim()||0===i.width||0===i.height||"none"===n.display||"hidden"===n.visibility||n.opacity},3e3);const s=this.container.querySelector(".body-rows");s.onclick=(t=>{const e=t.target.closest(".icon-delete-row"),i=t.target.closest(".icon-edit-row"),n=t.target.closest(".icon-view-row");e&&this.permissions.delete&&this.eliminarRegistros([e.closest("tr").getAttribute("data-id")]),i&&this.permissions.edit&&this.obtenerDetalle(i.closest("tr").getAttribute("data-id"),"edit"),n&&this.permissions.view&&this.obtenerDetalle(n.closest("tr").getAttribute("data-id"),"view")}),s.ondblclick=(t=>{const e=t.target.closest("td");e&&this.inlineEdit(e)});let o=0;s.addEventListener("touchstart",t=>{const e=Date.now(),i=e-o;if(o=e,i<300&&i>0){const e=t.target.closest("td");e&&this.inlineEdit(e)}},{passive:!0}),this.container.querySelector(".icon-delete").onclick=(()=>{const t=this.container.querySelectorAll(".row-check:checked");if(0===t.length)return;const e=Array.from(t).map(t=>t.dataset.id);this.eliminarRegistros(e)}),this.container.querySelector(".icon-refresh").onclick=(()=>this.refrescarTabla()),this.container.querySelector(".icon-export").onclick=(()=>this.exportarExcel()),this.container.querySelector(".btn-cancelar-todo").onclick=(()=>{this.container.querySelectorAll(".row-check").forEach(t=>{t.checked=!1,t.closest("tr").classList.remove("is-selected")});const t=this.container.querySelector(".check-all");t&&(t.checked=!1),this.toggleBarraAcciones()}),this.container.querySelector(".change-limit").onchange=(t=>{this.limite=parseInt(t.target.value),this.paginaActual=1,this.dibujar()}),this.container.querySelector(".table-search").oninput=(t=>this.filtrar(t.target.value)),this.seleccionable&&this.initMultiSelector();let a=null;s.addEventListener("dragstart",t=>{a=t.target.closest("tr"),a&&(a.classList.add("dragging"),t.dataTransfer.effectAllowed="move")}),s.addEventListener("dragover",t=>{if(!a)return;t.preventDefault();const e=t.target.closest("tr");if(e&&e!==a&&e.parentElement===s){const i=e.getBoundingClientRect(),n=t.clientY-i.top;n>i.height/2?e.after(a):e.before(a)}}),s.addEventListener("dragend",()=>{a&&(a.classList.remove("dragging"),this.actualizarOrdenTrasDrag(),a=null)}),await this.cargarDatos()}async cargarDatos(){try{const t=await fetch(this.url),e=await t.json();this.permissions=e.permissions||{},this.datosCompletos=e.data||[],this.datosFiltrados=[...this.datosCompletos],this.renderizarCabeceras(),this.dibujar()}catch(t){this.config.onError&&this.config.onError(t)}}async obtenerDetalle(t,e){if(this.urlDetail)try{const i=await fetch(this.urlDetail,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t})}),n=await i.json();"edit"===e&&this.config.onEdit&&this.config.onEdit(n),"view"===e&&this.config.onView&&this.config.onView(n)}catch(t){this.config.onEditError&&this.config.onEditError(t)}}renderizarCuerpo(t){const e=this.container.querySelector(".body-rows");if(e.innerHTML="",0===t.length){const t=this.columnas.length+(this.seleccionable?1:0),i=document.createElement("tr");return i.innerHTML=`<td colspan="${t}" style="text-align: center; padding: 40px; color: #666;">No hay datos disponibles</td>`,void e.appendChild(i)}t.forEach(t=>{const i=document.createElement("tr");if(i.setAttribute("data-id",t.id||""),this.draggable&&this.permissions.edit&&(i.draggable=!0,i.classList.add("draggable-row")),this.seleccionable){const e=document.createElement("td"),n=document.createElement("div");n.className="cell-with-handle",this.draggable&&this.permissions.edit&&(n.innerHTML='<span class="drag-handle">⋮⋮</span>'),n.innerHTML+=`<input type="checkbox" class="row-check" data-id="${t.id||""}">`,e.appendChild(n),i.appendChild(e)}if(this.columnas.forEach((e,n)=>{const s=document.createElement("td");if(!this.seleccionable&&0===n&&this.draggable&&this.permissions.edit){const i=document.createElement("div");i.className="cell-with-handle",i.innerHTML=`<span class="drag-handle">⋮⋮</span> <span>${t[e.data]||""}</span>`,s.appendChild(i)}else s.textContent=t[e.data]||"";i.appendChild(s)}),this.botonesFlotantes){const t=this.permissions.view?`<button class="btn-gmail-icon btn-row-action icon-view-row" title="Ver">${_MINI_ICONS.view}</button>`:"",e=this.permissions.edit?`<button class="btn-gmail-icon btn-row-action icon-edit-row" title="Editar">${_MINI_ICONS.edit}</button>`:"",n=this.permissions.delete?`<button class="btn-gmail-icon icon-delete-row" title="Eliminar">${_MINI_ICONS.delete}</button>`:"";if(t||e||n){const s=document.createElement("div");s.className="row-actions-floating",s.innerHTML=`${t}${e}${n}`,i.appendChild(s)}}e.appendChild(i)}),this.toggleBarraAcciones()}renderizarCabeceras(){const t=this.container.querySelector(".head-row");if(t.innerHTML="",this.seleccionable){const e=document.createElement("th"),i=document.createElement("div");i.className="header-aligner",this.draggable&&this.permissions.edit&&(i.innerHTML='<span class="handle-filler">⋮⋮</span>'),i.innerHTML+='<input type="checkbox" class="check-all">',e.appendChild(i),t.appendChild(e)}this.columnas.forEach((e,i)=>{const n=document.createElement("th");if(!this.seleccionable&&0===i&&this.draggable&&this.permissions.edit){const t=document.createElement("div");t.className="header-aligner",t.innerHTML=`<span class="handle-filler">⋮⋮</span> ${e.title}`,n.appendChild(t)}else n.textContent=e.title;n.style.cursor="pointer",n.onclick=(()=>this.ordenarPor(e.data)),t.appendChild(n)})}initMultiSelector(){this.container.addEventListener("change",t=>{if(t.target.classList.contains("check-all")){const e=t.target.checked;this.container.querySelectorAll(".row-check").forEach(t=>{t.checked=e,t.closest("tr").classList.toggle("is-selected",e)})}if(t.target.classList.contains("row-check")&&(t.target.closest("tr").classList.toggle("is-selected",t.target.checked),!t.target.checked)){const t=this.container.querySelector(".check-all");t&&(t.checked=!1)}this.toggleBarraAcciones()})}toggleBarraAcciones(){const t=this.container.querySelectorAll(".row-check:checked").length,e=this.container.querySelector(".menu-acciones-iconos"),i=this.container.querySelector(".mini-table-header"),n=e.querySelector(".icon-export"),s=n?n.parentElement:e.querySelector("div");if(s){let t=e.querySelector(".icon-delete");if(1==this.permissions.delete){if(!t){const t=document.createElement("button");t.className="btn-gmail-icon icon-delete",t.title="Eliminar seleccionados",t.innerHTML=_MINI_ICONS.delete,t.onclick=(()=>{const t=Array.from(this.container.querySelectorAll(".row-check:checked")).map(t=>t.dataset.id);t.length>0&&this.eliminarRegistros(t)}),s.prepend(t)}}else t&&t.remove();this.botonesExtra.forEach(t=>{let i=e.querySelector(`.btn-extra-${t.icon}`);if(!i){const e=document.createElement("button");e.className=`btn-gmail-icon btn-extra-${t.icon}`,e.title=t.title,_MINI_ICONS[t.icon]?e.innerHTML=_MINI_ICONS[t.icon]:e.innerHTML=`<i class="fa-solid ${t.icon}"></i>`,e.onclick=(()=>{const e=Array.from(this.container.querySelectorAll(".row-check:checked")).map(t=>t.dataset.id);t.action(e)}),s.appendChild(e)}})}e.style.display=t>0?"flex":"none",i&&(i.style.marginBottom=t>0?"0px":"20px")}ordenarPor(t){this.ordenColumna===t?this.ordenAscendente=!this.ordenAscendente:(this.ordenColumna=t,this.ordenAscendente=!0),this.datosFiltrados.sort((e,i)=>{let n=e[t],s=i[t];return n<s?this.ordenAscendente?-1:1:n>s?this.ordenAscendente?1:-1:0}),this.renderizarCabeceras(),this.dibujar()}filtrar(t){const e=t.toLowerCase();this.datosFiltrados=this.datosCompletos.filter(t=>this.columnas.some(i=>String(t[i.data]).toLowerCase().includes(e))),this.paginaActual=1,this.dibujar()}dibujar(){const t=(this.paginaActual-1)*this.limite,e=t+this.limite;this.renderizarCuerpo(this.datosFiltrados.slice(t,e)),this.renderizarPaginacion(Math.ceil(this.datosFiltrados.length/this.limite))}renderizarPaginacion(t){const e=this.container.querySelector(".mini-pagination");e.innerHTML="";const i=this.datosFiltrados.length,n=0===i?0:(this.paginaActual-1)*this.limite+1,s=Math.min(this.paginaActual*this.limite,i);if(t<1)return;const o=document.createElement("div");o.className="pagination-buttons-group";const a=(t,e,i=!1,n=!1)=>{const s=document.createElement("button");return s.innerHTML=t,i&&s.classList.add("active"),n&&(s.disabled=!0),s.onclick=(()=>{this.paginaActual=e,this.dibujar()}),s};o.appendChild(a("«",1,!1,1===this.paginaActual)),o.appendChild(a("‹",this.paginaActual-1,!1,1===this.paginaActual));let r=Math.max(1,this.paginaActual-2),c=Math.min(t,r+4);c-r<4&&(r=Math.max(1,c-4));for(let t=r;t<=c;t++)o.appendChild(a(t,t,t===this.paginaActual));o.appendChild(a("›",this.paginaActual+1,!1,this.paginaActual===t)),o.appendChild(a("»",t,!1,this.paginaActual===t));const l=document.createElement("div");l.className="pagination-info",l.style.fontSize="12px",l.style.color="#666",l.style.marginTop="8px",l.style.textAlign="center",l.innerText=`Mostrando ${n} a ${s} de ${i} resultados`,e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.appendChild(o),e.appendChild(l)}exportarExcel(){const t=Array.from(this.container.querySelectorAll(".row-check:checked")).map(t=>t.dataset.id),e=this.datosCompletos.filter(e=>t.includes(String(e.id))),i=this.columnas.map(t=>t.title).join(","),n=e.map(t=>this.columnas.map(e=>`"${t[e.data]}"`).join(",")).join("\n"),s="data:text/csv;charset=utf-8,\ufeff"+i+"\n"+n,o=document.createElement("a");o.setAttribute("href",encodeURI(s)),o.setAttribute("download","exportacion.csv"),document.body.appendChild(o),o.click(),document.body.removeChild(o)}async refrescarTabla(){const t=this.container.querySelector(".icon-refresh svg");t&&t.classList.add("is-spinning"),this.container.querySelector(".table-search").value="",this.paginaActual=1;try{await this.cargarDatos(),this.container.querySelector(".btn-cancelar-todo").click()}catch(t){console.error(t)}finally{setTimeout(()=>{t&&t.classList.remove("is-spinning")},600)}}async eliminarRegistros(t){if(this.config.onBeforeDelete){const e=await this.config.onBeforeDelete(t);if(!e)return}else if(!confirm(`¿Deseas eliminar ${t.length} registros?`))return;if(this.urlEliminar)try{const e=await fetch(this.urlEliminar,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:t})}),i=await e.json();i.success||!0===i?(this.procesarEliminacionLocal(t),this.config.onDeleteSuccess&&this.config.onDeleteSuccess(i)):this.config.onDeleteError&&this.config.onDeleteError(i)}catch(t){this.config.onDeleteError&&this.config.onDeleteError(t)}else this.procesarEliminacionLocal(t)}procesarEliminacionLocal(t){const e=t.map(t=>String(t));this.datosCompletos=this.datosCompletos.filter(t=>!e.includes(String(t.id))),this.datosFiltrados=this.datosFiltrados.filter(t=>!e.includes(String(t.id))),this.dibujar();const i=this.container.querySelector(".btn-cancelar-todo");i&&i.click()}async inlineEdit(t){if(!this.editable||!this.permissions.edit)return;if(t.querySelector("input"))return;const e=t.closest("tr"),i=e.getAttribute("data-id"),n=t.cellIndex-(this.seleccionable?1:0),s=this.columnas[n];if(!s||!1===s.editable)return;const o=t.textContent,a=s.data,r=document.createElement("input");r.value=o,r.className="inline-edit-input",t.innerHTML="",t.appendChild(r),r.focus(),r.select();const c=e=>{t.textContent=e};r.onkeydown=(async t=>{if("Escape"===t.key&&c(o),"Enter"===t.key){const t=r.value;if(t===o)return c(o);if(!this.urlUpdate)return this.actualizarDatoLocal(i,a,t),c(t);try{const e=await fetch(this.urlUpdate,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,field:a,value:t})}),n=await e.json();n.success?(this.actualizarDatoLocal(i,a,t),c(t),this.config.onUpdateSuccess&&this.config.onUpdateSuccess(n)):(c(o),this.config.onUpdateError&&this.config.onUpdateError(n))}catch(t){c(o)}}}),r.onblur=(()=>c(o))}actualizarDatoLocal(t,e,i){const n=this.datosCompletos.find(e=>String(e.id)===String(t));n&&(n[e]=i)}actualizarOrdenTrasDrag(){const t=Array.from(this.container.querySelectorAll(".body-rows tr")).map(t=>String(t.getAttribute("data-id"))),e=new Map(this.datosFiltrados.map(t=>[String(t.id),t]));this.datosFiltrados=t.map(t=>e.get(t)).filter(t=>void 0!==t),this.urlOrden&&fetch(this.urlOrden,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nuevoOrden:t})}).then(t=>t.json()).then(t=>{}).catch(t=>{this.config.onError&&this.config.onError(t)}),this.config.onReorder&&this.config.onReorder(this.datosFiltrados)}}